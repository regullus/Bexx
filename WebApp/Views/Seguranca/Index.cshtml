@{
    ViewData["Title"] = "Segurança";
    ViewData["SubTitle"] = "senha e autenticação";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Header{}
@section Scripts{
    <script>
        "use strict";
        var KTtab1 = function () {
            var _handleIdForm = function (e) {
                var validation;
                var form = KTUtil.getById('idFormtab_1');

                validation = FormValidation.formValidation(
                    form,
                    {
                        fields: {
                            senhaAtual: {
                                validators: {
                                    notEmpty: {
                                        message: 'A senha atual é necessária.'
                                    }
                                }
                            },
                            senhaNova: {
                                validators: {
                                    notEmpty: {
                                        message: 'A nova senha é necessária.'
                                    }
                                }
                            },
                            senhaConfirmar: {
                                validators: {
                                    notEmpty: {
                                        message: 'A confirmação da senha é necessária.'
                                    }
                                }
                            }
                        },
                        plugins: {
                            trigger: new FormValidation.plugins.Trigger(),
                            bootstrap: new FormValidation.plugins.Bootstrap(),
                            submitButton: new FormValidation.plugins.SubmitButton(),
                            defaultSubmit: new FormValidation.plugins.DefaultSubmit(),
                        }
                    }
                );

                $('.salvar').on('click', function (e) {
                    e.preventDefault();
                    validation.validate().then(function (status) {
                        if (status == 'Valid') {
                            KTApp.blockPage({
                                overlayColor: 'blue',
                                opacity: 0.1,
                                state: 'primary',
                                message: 'Aguarde...'
                            });

                            $(".tabCorrente").val("1");
                            form.submit();
                        } else {
                            swal.fire({
                                text: "Desculpe, parece que foram detectados alguns erros, tente novamente...",
                                icon: "error",
                                buttonsStyling: false,
                                confirmButtonText: "OK",
                                customClass: {
                                    confirmButton: "btn font-weight-bold btn-light-primary"
                                }
                            });
                            KTApp.unblockPage();
                        }
                    });
                });

                $(".cancelar").on('click', function (e) {
                    e.preventDefault();
                    Swal.fire({
                        title: "Tem certeza?",
                        text: "Todos os dados digitados serâo perdidos!",
                        icon: "warning",
                        showCancelButton: true,
                        cancelButtonText: "Não",
                        confirmButtonText: "Sim"
                    }).then(function (result) {
                        if (result.value) {
                            $(window.location).attr('href', '@Url.Action("Index","Seguranca")');
                        }
                    });
                });

                $(".esqueceuSenha").on("click", function (e) {
                    var _usuario = $("#EsqLogin").val();
                    var url = '@Url.Action("EsqueceuSenha", "Seguranca")';

                    KTApp.blockPage({
                        overlayColor: 'blue',
                        opacity: 0.1,
                        state: 'primary',
                        message: 'Aguarde...'
                    });

                    $.post(url, { _usuario: _usuario }, function (response) {
                        if (response == 'ok') {
                            $("#result_popup").html('Foi enviado um email para redefinição de sua senha.');
                        }
                        else {
                            $("#result_popup").html('Erro: ' + response);
                        }
                    }).always(function () {
                        KTApp.unblockPage();
                    });
                });
            }
            return {
                // public functions
                init: function () {
                    _handleIdForm();
                }
            };
        }();

        var KTtab2 = function () {
            var _handleIdForm = function (e) {
                var validation;
                var form = KTUtil.getById('idFormtab_2');

                $("#result_popup").html("");

                validation = FormValidation.formValidation(
                    form,
                    {
                        fields: {
                            token: {
                                validators: {
                                    notEmpty: {
                                        message: 'O token é necessário.'
                                    }
                                }
                            },
                        },
                        plugins: {
                            trigger: new FormValidation.plugins.Trigger(),
                            bootstrap: new FormValidation.plugins.Bootstrap(),
                            submitButton: new FormValidation.plugins.SubmitButton(),
                            defaultSubmit: new FormValidation.plugins.DefaultSubmit(),
                        }
                    }
                );

                $('.habilitar').on('click', function (e) {
                    e.preventDefault();
                    validation.validate().then(function (status) {
                        if (status == 'Valid') {
                            KTApp.blockPage({
                                overlayColor: 'blue',
                                opacity: 0.1,
                                state: 'primary',
                                message: 'Aguarde...'
                            });
                    /*        $("#resultHabilita").html("");*/
                            $(".tabCorrente").val("2");
                            $("#acao").val("habilitar");
                            form.submit();
                        } else {
                            swal.fire({
                                text: "Desculpe, parece que foram detectados alguns erros, tente novamente...",
                                icon: "error",
                                buttonsStyling: false,
                                confirmButtonText: "OK",
                                customClass: {
                                    confirmButton: "btn font-weight-bold btn-light-primary"
                                }
                            });
                            KTApp.unblockPage();
                        }
                    });
                });

                $('.desabilitar').on('click', function (e) {
                    e.preventDefault();
                    validation.validate().then(function (status) {
                        if (status == 'Valid') {
                            KTApp.blockPage({
                                overlayColor: 'blue',
                                opacity: 0.1,
                                state: 'primary',
                                message: 'Aguarde...'
                            });
                            $(".tabCorrente").val("2");
                            $("#acao").val("desabilitar");
                            form.submit();
                        } else {
                            swal.fire({
                                text: "Desculpe, parece que foram detectados alguns erros, tente novamente...",
                                icon: "error",
                                buttonsStyling: false,
                                confirmButtonText: "OK",
                                customClass: {
                                    confirmButton: "btn font-weight-bold btn-light-primary"
                                }
                            });
                            KTApp.unblockPage();
                        }
                    });
                });

                $.init = function (enabled) {
                    if (enabled == 'True') {
                        $(".desabilitar").show();
                        $(".habilitar").hide();
                    }
                    else {
                        $(".desabilitar").hide();
                        $(".habilitar").show();
                    }
                }

                $.get('@Url.Action("HabilitarGoogleAuthenticator","Seguranca")', function (response) {
                    if (response && response.ok) {
                        var img = $("#QCodeImg");
                        var path = img.attr("path");
                        $("#QCodeImg").attr("src", path + response.qrCodeImage)
                        $('#secretkey').val(response.secretkey);


                        console.log('@User.Identity.DoisFatoresHabilitado()');
                        $.init('@ViewBag.DoisFatoresHabilitado');
                    }
                    else {
                        $("#resultHabilita").html(response.mensagem);
                    }
                })
                .fail(function (data) {
                    console.log("Error HabilitarGoogleAuthenticator: ", data);
                });
            }
            return {
                // public functions
                init: function () {
                    _handleIdForm();
                }
            };
        }();

        jQuery(document).ready(function () {
            KTtab1.init();
            KTtab2.init();
        });

    </script>
}

<div class="card card-custom gutter-b">
    <div class="card card-custom">
        <!--begin::Card header-->
        <div class="card-header card-header-tabs-line nav-tabs-line-3x">
            <!--begin::Toolbar-->
            <div class="card-toolbar">
                <ul class="nav nav-tabs nav-bold nav-tabs-line nav-tabs-line-3x">
                    <!--begin::Item-->
                    <li class="nav-item mr-3">
                        <a class="nav-link @(ViewBag.TabCorrente=="1" ? "active" : "") " data-toggle="tab" href="#kt_seguranca_tab_1">
                            <span class="nav-icon">
                                <span class="svg-icon">
                                    <!--begin::Svg Icon | path:assets/media/svg/icons/Design/Layers.svg-->
                                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                        <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                            <mask fill="white">
                                                <use xlink:href="#path-1" />
                                            </mask>
                                            <g />
                                            <path d="M7,10 L7,8 C7,5.23857625 9.23857625,3 12,3 C14.7614237,3 17,5.23857625 17,8 L17,10 L18,10 C19.1045695,10 20,10.8954305 20,12 L20,18 C20,19.1045695 19.1045695,20 18,20 L6,20 C4.8954305,20 4,19.1045695 4,18 L4,12 C4,10.8954305 4.8954305,10 6,10 L7,10 Z M12,5 C10.3431458,5 9,6.34314575 9,8 L9,10 L15,10 L15,8 C15,6.34314575 13.6568542,5 12,5 Z" fill="#000000" />
                                        </g>
                                    </svg>
                                    <!--end::Svg Icon-->
                                </span>
                            </span>
                            <span class="nav-text font-size-lg">Senha</span>
                        </a>
                    </li>
                    <!--end::Item-->
                    <!--begin::Item-->
                    <li class="nav-item mr-3">
                        <a class="nav-link @(ViewBag.TabCorrente=="2" ? "active" : "") " data-toggle="tab" href="#kt_seguranca_tab_2">
                            <span class="nav-icon">
                                <span class="svg-icon">
                                    <!--begin::Svg Icon | path:assets/media/svg/icons/Communication/Shield-user.svg-->
                                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                        <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                            <rect x="0" y="0" width="24" height="24" />
                                            <path d="M4,4 L11.6314229,2.5691082 C11.8750185,2.52343403 12.1249815,2.52343403 12.3685771,2.5691082 L20,4 L20,13.2830094 C20,16.2173861 18.4883464,18.9447835 16,20.5 L12.5299989,22.6687507 C12.2057287,22.8714196 11.7942713,22.8714196 11.4700011,22.6687507 L8,20.5 C5.51165358,18.9447835 4,16.2173861 4,13.2830094 L4,4 Z" fill="#000000" opacity="0.3" />
                                            <path d="M12,11 C10.8954305,11 10,10.1045695 10,9 C10,7.8954305 10.8954305,7 12,7 C13.1045695,7 14,7.8954305 14,9 C14,10.1045695 13.1045695,11 12,11 Z" fill="#000000" opacity="0.3" />
                                            <path d="M7.00036205,16.4995035 C7.21569918,13.5165724 9.36772908,12 11.9907452,12 C14.6506758,12 16.8360465,13.4332455 16.9988413,16.5 C17.0053266,16.6221713 16.9988413,17 16.5815,17 C14.5228466,17 11.463736,17 7.4041679,17 C7.26484009,17 6.98863236,16.6619875 7.00036205,16.4995035 Z" fill="#000000" opacity="0.3" />
                                        </g>
                                    </svg>
                                    <!--end::Svg Icon-->
                                </span>
                            </span>
                            <span class="nav-text font-size-lg">Verificação em duas etapas</span>
                        </a>
                    </li>
                    <!--end::Item-->
                </ul>
            </div>
            <!--end::Toolbar-->
        </div>
        <!--end::Card header-->
        <!--begin::Card body-->
        <div class="card-body">
            <div class="tab-content">
                <!--begin::Tab-->
                <div class="tab-pane  px-7 @(ViewBag.TabCorrente=="1" ? "active" : "") " id="kt_seguranca_tab_1" role="tabpanel">
                    <form class="form" id="idFormtab_1" asp-action="Index" enctype="multipart/form-data">
                        <input hidden type="text" class="tabCorrente" name="tabCorrente" value="1" />
                        <!--begin::Body-->
                        <div class="card-body">
                            <!--begin::Row-->
                            <div class="row">
                                <div class="col-xl-2"></div>
                                <div class="col-xl-7 my-2">
                                    <!--begin::Row-->
                                    <div class="row">
                                        <label class="col-3"></label>
                                        <div class="col-9">
                                            <h6 class="text-dark font-weight-bold mb-10">Alterar ou recuperar sua senha:</h6>
                                        </div>
                                    </div>
                                    <!--end::Row-->
                                    <!--begin::Group-->
                                    <div class="form-group row">
                                        <label class="col-form-label col-3 text-lg-right text-left">Senha atual</label>
                                        <div class="col-9">
                                            <input class="form-control mb-1" type="password" value="@ViewBag.SenhaAtual" id="senhaAtual" name="senhaAtual" autocomplete="off" />
                                            @*<a href="javascript:;" id="kt_login_forgot" class="font-weight-bold font-size-sm">Esqueceu a senha ?</a>*@
                                            <a href="#" class="font-weight-bold font-size-sm" data-toggle="modal" data-target="#kt_popup_modal">Esqueceu a senha ?</a>
                                        </div>
                                    </div>
                                    <!--end::Group-->
                                    <!--begin::Group-->
                                    <div class="form-group row">
                                        <label class="col-form-label col-3 text-lg-right text-left">Nova senha</label>
                                        <div class="col-9">
                                            <input class="form-control" type="password" value="@ViewBag.SenhaNova" id="senhaNova" name="senhaNova" autocomplete="off" />
                                        </div>
                                    </div>
                                    <!--end::Group-->
                                    <!--begin::Group-->
                                    <div class="form-group row">
                                        <label class="col-form-label col-3 text-lg-right text-left">Confirmação da senha</label>
                                        <div class="col-9">
                                            <input class="form-control" type="password" value="@ViewBag.SenhaConfirmar" id="senhaConfirmar" name="senhaConfirmar" autocomplete="off" />
                                        </div>
                                    </div>
                                    <!--end::Group-->
                                </div>
                            </div>
                            <!--end::Row-->
                        </div>
                        <!--end::Body-->
                        <!--begin::Footer-->
                        <!--begin::Card footer-->
                        <div class="card-footer d-flex justify-content-end">
                            <!--begin::Button-->
                            <button type="button" class="btn btn-light-success mr-2  mt-2 text-right salvar" id="btnSalvar">
                                <i class="flaticon-edit-1"></i> Salvar
                            </button>

                            <button type="reset" class="btn btn-light-dark mr-2 mt-2 cancelar">
                                <i class="flaticon-cancel"></i> Cancelar
                            </button>
                            <a href='@Url.Action("Index", "Home")' class="btn btn-light-primary font-weight-bolder mr-2 mt-2">
                                <span class="svg-icon svg-icon-md">
                                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                        <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                            <rect x="0" y="0" width="24" height="24" />
                                            <circle fill="#000000" opacity="0.3" cx="12" cy="12" r="10" />
                                            <path d="M6.96323356,15.1775211 C6.62849853,15.5122561 6.08578582,15.5122561 5.75105079,15.1775211 C5.41631576,14.842786 5.41631576,14.3000733 5.75105079,13.9653383 L10.8939067,8.82248234 C11.2184029,8.49798619 11.7409054,8.4866328 12.0791905,8.79672747 L17.2220465,13.5110121 C17.5710056,13.8308912 17.5945795,14.3730917 17.2747004,14.7220508 C16.9548212,15.0710098 16.4126207,15.0945838 16.0636617,14.7747046 L11.5257773,10.6149773 L6.96323356,15.1775211 Z" fill="#000000" fill-rule="nonzero" transform="translate(11.500001, 12.000001) scale(-1, 1) rotate(-270.000000) translate(-11.500001, -12.000001) " />
                                        </g>
                                    </svg>
                                </span>Voltar
                            </a>
                            <!--end::Button-->
                        </div>
                        <!--end::Card footer-->
                    </form>
                </div>
                <!--end::Tab-->
                <!--begin::Tab-->
                <div class="tab-pane px-7 @(ViewBag.TabCorrente=="2" ? "active" : "")" id="kt_seguranca_tab_2" role="tabpanel">
                    <form class="form" id="idFormtab_2" asp-action="Index" enctype="multipart/form-data">
                        <input hidden type="text" class="tabCorrente" name="tabCorrente" value="2" />
                        <input hidden type="text" id="acao" name="acao" value="" />
                        <input hidden type="text" id="secretkey" name="secretkey" value="@ViewBag.Secretkey" />

                        <!--begin::Body-->
                        <div class="card-body">
                            @*<samp>@User.Identity.DoisFatoresHabilitado()</samp>
                                <samp>@User.Identity.AutenticadorGoogleChaveSecreta()</samp>*@

                            <!--begin::Row-->
                            <div class="row">
                                <div class="col-xl-2"> <img src="@Url.Content("~/img/seguranca/google-authenticator.jpg")" width="80" /></div>
                                <div class="col-xl-10">
                                    <!--begin::Row-->
                                    <div class="row mb-5">
                                        <div class="col-10 habilitar">
                                            <div class="alert alert-custom alert-light-danger fade show py-4" role="alert">
                                                <div class="alert-icon">
                                                    <span class="svg-icon svg-icon-3x svg-icon-danger">
                                                        <!--begin::Svg Icon | path:assets/media/svg/icons/Code/Info-circle.svg-->
                                                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                                            <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                                                <rect x="0" y="0" width="24" height="24" />
                                                                <circle fill="#000000" opacity="0.3" cx="12" cy="12" r="10" />
                                                                <rect fill="#000000" x="11" y="10" width="2" height="7" rx="1" />
                                                                <rect fill="#000000" x="11" y="7" width="2" height="2" rx="1" />
                                                            </g>
                                                        </svg>
                                                        <!--end::Svg Icon-->
                                                    </span>
                                                </div>
                                                <div class="alert-text font-weight-bold">
                                                    1 - Instale o aplicativo Google Authenticator no seu celular;<br />
                                                    2 - Pelo aplicativo, leia o QrCode;<br />
                                                    3 - Insira o token que está aparecendo no aplicativo, no campo a baixo;
                                                </div>
                                                <div class="alert-close">
                                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                                        <span aria-hidden="true">
                                                            <i class="la la-close"></i>
                                                        </span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-10 desabilitar" style="padding: 10px 0px 10px 10px">
                                            <b>Seu token está ativo!</b><br />
                                            <p>Para desebilitar a autenticação em dois fatores informe o token.</p>
                                        </div>

                                        <div class="col-10 habilitar">
                                            <div id="validacao-form" class="form-group form-md-line-input form-md-floating-label text-center">
                                                <div class="col-4">
                                                    <div class="card card-custom card-stretch">
                                                        <img id="QCodeImg" path="http://qrcode.kaywa.com/img.php?s=4&d=" /><br />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-7">
                                            <div class="form-group row">
                                                <div class="col-12">
                                                    <div class="input-group input-group-lg">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">
                                                                <i class="la la-key"></i>
                                                            </span>
                                                        </div>
                                                        <input type="text" class="form-control" id="token" name="token" placeholder="Insira o token que aparece no aplicativo" required autocomplete="off" />
                                                    </div>
                                                    <span class="form-text text-danger"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--begin::Row-->
                                </div>
                            </div>
                            <!--end::Row-->
                        </div>
                        <!--end::Body-->
                        <!--begin::Card footer-->
                        <div class="card-footer d-flex justify-content-end">
                            <!--begin::Button-->
                            <button type="button" class="btn btn-light-success mr-2 mt-2 text-right desabilitar validar" id="btnDesabilitarr">
                                <i class="flaticon-edit-1"></i> Desabilitar
                            </button>

                            <button type="button" class="btn btn-light-success mr-2 mt-2 text-right habilitar validar" id="btnValidarr">
                                <i class="flaticon-edit-1"></i> Validar
                            </button>

                            <button type="reset" class="btn btn-light-dark mr-2 mt-2 cancelar">
                                <i class="flaticon-cancel"></i> Cancelar
                            </button>
                            <a href='@Url.Action("Index", "Home")' class="btn btn-light-primary font-weight-bolder mr-2 mt-2">
                                <span class="svg-icon svg-icon-md">
                                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                                        <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                            <rect x="0" y="0" width="24" height="24" />
                                            <circle fill="#000000" opacity="0.3" cx="12" cy="12" r="10" />
                                            <path d="M6.96323356,15.1775211 C6.62849853,15.5122561 6.08578582,15.5122561 5.75105079,15.1775211 C5.41631576,14.842786 5.41631576,14.3000733 5.75105079,13.9653383 L10.8939067,8.82248234 C11.2184029,8.49798619 11.7409054,8.4866328 12.0791905,8.79672747 L17.2220465,13.5110121 C17.5710056,13.8308912 17.5945795,14.3730917 17.2747004,14.7220508 C16.9548212,15.0710098 16.4126207,15.0945838 16.0636617,14.7747046 L11.5257773,10.6149773 L6.96323356,15.1775211 Z" fill="#000000" fill-rule="nonzero" transform="translate(11.500001, 12.000001) scale(-1, 1) rotate(-270.000000) translate(-11.500001, -12.000001) " />
                                        </g>
                                    </svg>
                                </span>Voltar
                            </a>
                            <!--end::Button-->
                        </div>
                        <!--end::Card footer-->
                    </form>
                </div>
                <!--end::Tab-->
            </div>
        </div>
        <!--end::Card body-->
    </div>
</div>

<!--begin::Chat Panel-->
<div class="modal modal-sticky modal-sticky-bottom-right" id="kt_popup_modal" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <!--begin::Card-->
            <div class="card card-custom">
                <!--begin::Header-->
                <div class="card-header align-items-center px-4 py-3">
                    <div class="flex-grow-1">
                        <div class="text-dark-75 font-weight-bold font-size-h5">Esqueceu a senha ?</div>
                    </div>
                    <div class="text-right flex-grow-1">
                        <button type="button" class="btn btn-clean btn-sm btn-icon btn-icon-md" data-dismiss="modal">
                            <i class="ki ki-close icon-1x"></i>
                        </button>
                    </div>
                </div>
                <!--end::Header-->
                <form class="form" id="kt_login_forgot_form">
                    <!--begin::Body-->
                    <div class="card-body">
                        <div class="login-forgot">
                            <div class="mb-10">
                                <p>Entre com seu login ou email para cadastrar uma nova senha</p>
                            </div>
                            <input name="token" id="tokenEsqueci" hidden />
                            <div class="form-group mb-5">
                                <input class="form-control h-auto rounded-pill border-1 py-4 px-8" disabled type="text" value="@User.Identity.Login()" placeholder="Login ou email" name="login" autocomplete="off" id="EsqLogin" />
                            </div>
                            <div class="row">
                                <div class="col-md-12" style="text-align:center">
                                    <span id="result_popup"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--end::Body-->
                    <!--begin::Footer-->
                    <div class="card-footer align-items-center">
                        <!--begin::Compose-->
                        <div class="d-flex align-items-center justify-content-between">
                            <button type="button" id="btnEnviar" class="btn btn-light-success btn-md text-uppercase font-weight-bold chat-send py-3 px-6 esqueceuSenha">Enviar</button>
                            <button type="button" id="kt_login_forgot_cancel" class="btn btn-light-danger btn-md text-uppercase font-weight-bold chat-send py-3 px-6" data-dismiss="modal">Cancelar</button>
                        </div>
                        <!--begin::Compose-->
                    </div>
                    <!--end::Footer-->
                </form>
            </div>
            <!--end::Card-->
        </div>
    </div>
</div>
